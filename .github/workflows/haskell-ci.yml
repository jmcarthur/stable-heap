# This GitHub workflow config has been generated by a script via
#
#   haskell-ci 'github' 'stable-heap.cabal'
#
# To regenerate the script (for example after adjusting tested-with) run
#
#   haskell-ci regenerate
#
# For more information, see https://github.com/haskell-CI/haskell-ci
#
# version: 0.19 (manual)
#
name: Haskell-CI
on:
  - push
  - pull_request
jobs:
  linux:
    name: Haskell-CI - Linux - ${{ matrix.compiler }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    continue-on-error: ${{ matrix.allow-failure }}
    strategy:
      matrix:
        include:
          - compiler: ghc-9.12.2
            compilerKind: ghc
            compilerVersion: 9.12.2
            allow-failure: false
          - compiler: ghc-9.10.3
            compilerKind: ghc
            compilerVersion: 9.10.3
            allow-failure: false
          - compiler: ghc-9.8.4
            compilerKind: ghc
            compilerVersion: 9.8.4
            allow-failure: false
          - compiler: ghc-9.6.7
            compilerKind: ghc
            compilerVersion: 9.6.7
            allow-failure: false
      fail-fast: false
    steps:
      - name: Set up GHC ${{ matrix.compilerVersion }}
        uses: haskell-actions/setup@v2
        id: setup
        with:
          ghc-version: ${{ matrix.compilerVersion }}
          cabal-version: latest

      - name: Set environment variables
        run: |
          echo "CABAL_DIR=$HOME/.cabal" >> "$GITHUB_ENV"
          echo "CABAL_CONFIG=$HOME/.cabal/config" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: source

      - name: Restore cache
        uses: actions/cache/restore@v4
        with:
          key: ${{ runner.os }}-${{ matrix.compiler }}-${{ github.sha }}
          path: ~/.cabal/store
          restore-keys: ${{ runner.os }}-${{ matrix.compiler }}-

      - name: Update cabal index
        run: cabal update

      - name: Initial cabal.project for sdist
        run: |
          touch cabal.project
          echo "packages: $GITHUB_WORKSPACE/source/." >> cabal.project
          cat cabal.project

      - name: Create sdist
        run: |
          mkdir -p sdist
          cabal sdist all --output-dir $GITHUB_WORKSPACE/sdist

      - name: Unpack sdist
        run: |
          mkdir -p unpacked
          find sdist -maxdepth 1 -type f -name '*.tar.gz' -exec tar -C $GITHUB_WORKSPACE/unpacked -xzvf {} \;

      - name: Generate cabal.project
        run: |
          PKGDIR_stable_heap="$(find "$GITHUB_WORKSPACE/unpacked" -maxdepth 1 -type d -regex '.*/stable-heap-[0-9.]*')"
          echo "PKGDIR_stable_heap=${PKGDIR_stable_heap}" >> "$GITHUB_ENV"
          rm -f cabal.project cabal.project.local
          touch cabal.project
          echo "packages: ${PKGDIR_stable_heap}" >> cabal.project
          echo "package stable-heap" >> cabal.project
          echo "    ghc-options: -Werror=missing-methods" >> cabal.project
          cat cabal.project

      - name: Build dependencies
        run: |
          cabal build --enable-tests --enable-benchmarks --dependencies-only -j2 all

      - name: Build
        run: |
          cabal build --enable-tests --enable-benchmarks all

      - name: Run tests
        run: |
          cabal test --enable-tests all --test-show-details=direct

      - name: Check
        run: |
          cd ${PKGDIR_stable_heap}
          cabal check

      - name: Haddock
        run: |
          cabal haddock --enable-tests --enable-benchmarks all

      - name: Save cache
        uses: actions/cache/save@v4
        if: always()
        with:
          key: ${{ runner.os }}-${{ matrix.compiler }}-${{ github.sha }}
          path: ~/.cabal/store
